<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
  <title>–†–µ—à–µ–Ω–∏–µ –ø—Ä–æ—Å—Ç—ã—Ö –∑–∞–¥–∞—á ‚Äî –¢—Ä–µ–Ω–∞–∂—ë—Ä (—Å–ª–æ–≤–µ—Å–Ω—ã–µ –∑–∞–¥–∞—á–∏)</title>
  <meta name="description" content="–ü—Ä–æ—Å—Ç—ã–µ —Å–ª–æ–≤–µ—Å–Ω—ã–µ –∑–∞–¥–∞—á–∏ –¥–ª—è 2 –∫–ª–∞—Å—Å–∞: –ø–µ—Ä–µ–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ –≤ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –º–æ–¥–µ–ª—å, –ø–æ–¥—Å–∫–∞–∑–∫–∏ –∏ —Ä–µ–∂–∏–º –ø–æ–º–æ—â–∏.">
  <style>
    :root{--bg:#f7fbff;--card:#fff;--accent:#2b8cff;--muted:#6b7280;--success:#2aa653;--error:#e03d3d}
    *{box-sizing:border-box}
    body{margin:0;padding:14px;font-family:Inter,Segoe UI,Arial,Helvetica,sans-serif;background:var(--bg);color:#071029}
    .home-btn { display: inline-block; margin: 10px 0; padding: 10px 14px; font-size: 16px; background-color: #4CAF50; color: white; border-radius: 8px; text-decoration: none; }
    header{display:flex;gap:12px;align-items:center;max-width:980px;margin:0 auto 12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7cc4ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    h1{font-size:1.15rem;margin:0}
    .meta{color:var(--muted);font-size:0.92rem}
    main{max-width:980px;margin:0 auto;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(15,23,42,0.06)}

    .controls{display:flex;flex-direction:column;gap:8px}
    .controls-row{display:flex;gap:8px;align-items:center}
    select,input,button{padding:10px;border-radius:10px;border:1px solid #e6eefc;background:white}
    .right{margin-left:auto;color:var(--muted)}

    .game{display:flex;flex-direction:column;gap:12px}
    .panel{padding:14px;border-radius:12px;background:linear-gradient(180deg,#fff,#fbfdff);border:1px solid #eef6ff}

    .card{display:flex;gap:12px;align-items:flex-start}
    .illustration{width:110px;min-width:110px;border-radius:8px;padding:8px;background:linear-gradient(180deg,#f2f8ff,#fff);display:flex;align-items:center;justify-content:center}
    .problem{flex:1}
    .problem h2{margin:0;font-size:1.15rem}
    .problem p{margin:8px 0;font-size:1.05rem}

    .help-box{background:#fbfdff;border:1px solid #e6f0ff;padding:10px;border-radius:8px;color:#16325c}
    .known-unknown{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
    .known, .unknown{flex:1;min-width:140px;padding:8px;border-radius:8px;background:#fff;border:1px solid #eef6ff}

    .answer-row{display:flex;gap:8px;align-items:center;margin-top:10px}
    .answer-row input{width:110px;padding:10px;font-size:1rem;border-radius:8px;border:1px solid #e6eefc}

    .modes{display:flex;gap:8px;align-items:center}

    .feedback{min-height:48px;font-weight:700;text-align:center;margin-top:8px}
    .feedback.success{color:var(--success)}
    .feedback.error{color:var(--error)}

    .controls-bottom{display:flex;gap:8px;justify-content:center;margin-top:12px}

    @media(min-width:880px){ .controls{flex-direction:row} .game{flex-direction:row} .panel{flex:1} }
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>
  <a href="index.html" class="home-btn">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>

  <header>
    <div class="logo">–ú2</div>
    <div>
      <h1>–°–ª–æ–≤–µ—Å–Ω—ã–µ –∑–∞–¥–∞—á–∏</h1>
      <div class="meta">–£—á–∏–º—Å—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å —Ç–µ–∫—Å—Ç –≤ –º–∞—Ç–µ–º–∞—Ç–∏—á–µ—Å–∫—É—é –º–æ–¥–µ–ª—å –∏ —Ä–µ—à–∞—Ç—å.</div>
    </div>
  </header>

  <main>
    <div class="controls" role="region" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
      <div class="controls-row">
        <label class="sr-only">–£—Ä–æ–≤–µ–Ω—å</label>
        <select id="level" aria-label="–£—Ä–æ–≤–µ–Ω—å">
          <option value="1">1 ‚Äî –æ–¥–Ω–∞ –æ–ø–µ—Ä–∞—Ü–∏—è, —á–∏—Å–ª–∞ ‚â§ 20</option>
          <option value="2">2 ‚Äî –¥–≤–µ –æ–ø–µ—Ä–∞—Ü–∏–∏, –≤–æ–∑–º–æ–∂–Ω–æ —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º</option>
          <option value="3">3 ‚Äî –∑–∞–¥–∞—á–∏ —Å –µ–¥–∏–Ω–∏—Ü–∞–º–∏ –∏–∑–º–µ—Ä–µ–Ω–∏—è</option>
        </select>

        <label class="sr-only">–†–µ–∂–∏–º –ø–æ–º–æ—â–∏</label>
        <div class="modes">
          <label><input type="checkbox" id="helpMode"> –†–µ–∂–∏–º –ø–æ–º–æ—â–∏</label>
        </div>

        <label class="sr-only">–î–ª–∏–Ω–∞ —Å–µ—Ä–∏–∏</label>
        <input id="seriesCount" type="number" min="1" max="30" value="8" style="width:92px" aria-label="–î–ª–∏–Ω–∞ —Å–µ—Ä–∏–∏">

        <div class="right">–õ—É—á—à–∏–π: <span id="best">‚Äî</span></div>
      </div>

      <div class="controls-row" style="align-items:center">
        <input id="student" placeholder="–ò–º—è —É—á–µ–Ω–∏–∫–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)" style="flex:1">
        <div class="right">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="progress">0/8</span></div>
      </div>
    </div>

    <section class="game">
      <article class="panel">
        <div class="card">
          <div class="illustration" id="illustration" aria-hidden="true">
            <!-- simple SVG placeholder: —è–±–ª–æ–∫–∏ -->
            <svg width="88" height="68" viewBox="0 0 88 68" xmlns="http://www.w3.org/2000/svg">
              <g fill="#ff7b7b">
                <circle cx="18" cy="38" r="12" />
                <circle cx="38" cy="28" r="12" />
                <circle cx="58" cy="38" r="12" />
              </g>
            </svg>
          </div>

          <div class="problem">
            <h2 id="title">‚Äî</h2>
            <p id="text">‚Äî</p>

            <div class="help-box" id="hintBox">
              <div><strong>–ß—Ç–æ –∏–∑–≤–µ—Å—Ç–Ω–æ:</strong></div>
              <div class="known-unknown">
                <div class="known" id="known">‚Äî</div>
                <div class="unknown" id="unknown">‚Äî</div>
              </div>
            </div>

            <div id="helpPrompts" style="margin-top:10px"></div>

            <div class="answer-row">
              <label>–û—Ç–≤–µ—Ç: <input id="answerInput" type="number" inputmode="numeric" aria-label="–û—Ç–≤–µ—Ç"></label>
              <button id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
              <button id="showBtn">–ü–æ–∫–∞–∑–∞—Ç—å —Ä–µ—à–µ–Ω–∏–µ</button>
            </div>

            <div id="explanation" style="margin-top:10px;color:#164062"></div>
            <div id="feedback" class="feedback" role="status" aria-live="polite">&nbsp;</div>
          </div>
        </div>

        <div class="controls-bottom">
          <button id="nextBtn">–°–ª–µ–¥—É—é—â–∞—è –∑–∞–¥–∞—á–∞</button>
          <button id="skipBtn">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
        </div>
      </article>

      <aside class="panel" style="width:320px">
        <h3 style="margin-top:0">–†–µ–∂–∏–º –ø–æ–º–æ—â–∏</h3>
        <p style="color:var(--muted)">–ï—Å–ª–∏ –≤–∫–ª—é—á—ë–Ω ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –∫–æ—Ä–æ—Ç–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø–æ–º–æ–≥–∞—é—Ç –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Ç–µ–∫—Å—Ç –≤ –º–æ–¥–µ–ª—å.</p>
        <div style="margin-top:12px">–†–µ–∑—É–ª—å—Ç–∞—Ç: <div id="resultSummary" style="margin-top:8px;color:var(--muted)">‚Äî</div></div>
      </aside>
    </section>
  </main>

  <footer style="max-width:980px;margin:12px auto 0;color:var(--muted)">–°–±–æ—Ä–Ω–∏–∫ –∑–∞–¥–∞—á –æ—Å–Ω–æ–≤–∞–Ω –Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–µ: –ú–æ—Ä–æ –∏ –¥—Ä. (2 –∫–ª–∞—Å—Å)</footer>

<script>
(function(){
  // DOM
  const levelEl = document.getElementById('level');
  const helpModeEl = document.getElementById('helpMode');
  const titleEl = document.getElementById('title');
  const textEl = document.getElementById('text');
  const knownEl = document.getElementById('known');
  const unknownEl = document.getElementById('unknown');
  const helpPrompts = document.getElementById('helpPrompts');
  const answerInput = document.getElementById('answerInput');
  const checkBtn = document.getElementById('checkBtn');
  const showBtn = document.getElementById('showBtn');
  const nextBtn = document.getElementById('nextBtn');
  const skipBtn = document.getElementById('skipBtn');
  const explanationEl = document.getElementById('explanation');
  const feedback = document.getElementById('feedback');
  const seriesCountEl = document.getElementById('seriesCount');
  const progressEl = document.getElementById('progress');
  const resultSummary = document.getElementById('resultSummary');
  const student = document.getElementById('student');
  const best = document.getElementById('best');

  // state
  let current = null; // {id,type, text, solution, model, steps}
  let seriesTotal = Math.max(1, parseInt(seriesCountEl.value||'8',10));
  let seriesCurrent = 0;
  let streak = parseInt(localStorage.getItem('wp_streak')||'0',10)||0;
  let bestv = parseInt(localStorage.getItem('wp_best')||'0',10)||0;
  best.textContent = bestv>0?('‚òÖ'.repeat(Math.min(bestv,3))):'‚Äî';

  // helpers
  function rand(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

  // generators ‚Äî ensure all solutions and intermediate steps are natural (>=0)
  function genLevel1(){
    const a = rand(2,20);
    const b = rand(1, Math.min(10,a)); // ensure b<=a for subtraction
    if(Math.random()<0.6){ // addition
      return { type:'add', text:`–£ –ú–∞—à–∏ –±—ã–ª–æ ${a} —è–±–ª–æ–∫, –µ–π –¥–∞–ª–∏ –µ—â—ë ${b}. –°–∫–æ–ª—å–∫–æ —Å—Ç–∞–ª–æ?`, solution: a+b, model:`${a} + ${b}`, steps:[`–°–∫–æ–ª—å–∫–æ –±—ã–ª–æ? ${a}. –°–∫–æ–ª—å–∫–æ –¥–∞–ª–∏? ${b}. –°–ª–æ–∂–∏—Ç—å: ${a} + ${b} = ${a+b}`] };
    } else {
      return { type:'sub', text:`–£ –ü–µ—Ç–∏ –±—ã–ª–æ ${a} –∫–æ–Ω—Ñ–µ—Ç, –æ–Ω –æ—Ç–¥–∞–ª ${b}. –°–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å?`, solution: a-b, model:`${a} - ${b}`, steps:[`–°–∫–æ–ª—å–∫–æ –±—ã–ª–æ? ${a}. –°–∫–æ–ª—å–∫–æ –æ—Ç–¥–∞–ª? ${b}. –í—ã—á–µ—Å—Ç—å: ${a} - ${b} = ${a-b}`] };
    }
  }

  function genLevel2(){
    // two-step: generate scenarios but guarantee non-negative intermediate steps and final answer
    // We'll try until constraints satisfied
    while(true){
      const a = rand(5,25);
      const b = rand(1,12);
      const c = rand(1,12);
      if(Math.random()<0.5){ // (a+b)-c, require a+b >= c
        if(a + b >= c){
          const sol = a + b - c;
          return {
            type:'chain',
            text:`–£ –í–∞–Ω–∏ –±—ã–ª–æ ${a} –∫–∞—Ä–∞–Ω–¥–∞—à–µ–π. –ï–º—É –¥–∞–ª–∏ –µ—â—ë ${b}. –ü–æ—Ç–æ–º –æ–Ω –ø–æ—Ç–µ—Ä—è–ª ${c}. –°–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å?`,
            solution: sol,
            model:`(${a} + ${b}) - ${c}`,
            steps:[`–°–ª–æ–∂–∏—Ç—å —Å–Ω–∞—á–∞–ª–∞: ${a} + ${b} = ${a+b}. –ó–∞—Ç–µ–º –≤—ã—á–µ—Å—Ç—å ${c}: ${a+b} - ${c} = ${sol}`]
          };
        }
      } else { // (a-b)+c, require a >= b so first subtraction non-negative
        if(a >= b){
          const sol = a - b + c;
          return {
            type:'chain',
            text:`–£ –¥–µ–≤–æ—á–∫–∏ –±—ã–ª–æ ${a} –Ω–∞–∫–ª–µ–µ–∫, –æ–Ω–∞ –æ—Ç–¥–∞–ª–∞ ${b}, –∞ –ø–æ—Ç–æ–º –µ–π –ø–æ–¥–∞—Ä–∏–ª–∏ ${c}. –°–∫–æ–ª—å–∫–æ —Å—Ç–∞–ª–æ?`,
            solution: sol,
            model:`(${a} - ${b}) + ${c}`,
            steps:[`–í—ã—á–µ—Å—Ç—å —Å–Ω–∞—á–∞–ª–∞: ${a} - ${b} = ${a-b}. –ü–æ—Ç–æ–º –¥–æ–±–∞–≤–∏—Ç—å ${c}: ${a-b} + ${c} = ${sol}`]
          };
        }
      }
      // otherwise loop again
    }
  }

  function genLevel3(){
    // units: sums and subtractions with cm/dm ‚Äî ensure final result >= 0
    while(true){
      const dm = rand(1,6); const cm = rand(0,9); const addDm = rand(0,3); const addCm = rand(0,9);
      if(Math.random()<0.5){
        // sum ‚Äî always non-negative
        const text = `${dm} –¥–º ${cm} —Å–º –∏ –µ—â—ë ${addDm} –¥–º ${addCm} —Å–º. –°–∫–æ–ª—å–∫–æ –≤—Å–µ–≥–æ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–æ–≤?`;
        const total = (dm*10+cm) + (addDm*10+addCm);
        return {
          type:'units-sum',
          text,
          solution: total,
          model:`(${dm}*10+${cm})+(${addDm}*10+${addCm})`,
          steps:[`–ü–µ—Ä–µ–≤–µ–¥—ë–º –≤ —Å–º: ${dm} –¥–º ${cm} —Å–º = ${dm*10+cm} —Å–º; ${addDm} –¥–º ${addCm} —Å–º = ${addDm*10+addCm} —Å–º. –°–ª–æ–∂–∏—Ç—å: ${dm*10+cm} + ${addDm*10+addCm} = ${total}`]
        };
      } else {
        // subtraction: ensure (dm*10+cm) >= (addDm*10+addCm)
        const left = dm*10 + cm; const right = addDm*10 + addCm;
        if(left >= right){
          const text = `–ë—ã–ª–æ ${dm} –¥–º ${cm} —Å–º. –û—Ç–Ω—è–ª–∏ ${addDm} –¥–º ${addCm} —Å–º. –°–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–æ–≤?`;
          const total = left - right;
          return {
            type:'units-sub',
            text,
            solution: total,
            model:`(${dm}*10+${cm})-(${addDm}*10+${addCm})`,
            steps:[`–ü–µ—Ä–µ–≤–µ–¥—ë–º –≤ —Å–º –∏ –≤—ã—á—Ç–µ–º: ${left} - ${right} = ${total}`]
          };
        }
      }
    }
  }

  // Robust helpers for extracting 'known' numbers ‚Äî avoids exceptions if no digits found
  function getKnownText(p){
    try {
      if(!p || !p.text) return '‚Äî';
      const nums = p.text.match(/\d+/g);
      if(!nums || nums.length === 0) return '‚Äî';
      return nums.slice(0,3).join(', ');
    } catch(err){
      console.error('getKnownText error:', err);
      return '‚Äî';
    }
  }

  function getUnknownText(p){
    if(!p) return '‚Äî';
    if(p.type && p.type.startsWith('units')) return '–ù–∞–π–¥–∏—Ç–µ –¥–ª–∏–Ω—É (—Å–º).';
    return '–ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ (–æ—Ç–≤–µ—Ç –≤ —É—Å–ª–æ–≤–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü–∞—Ö).';
  }

  // UI helpers
  function renderProblem(p){
    current = p;
    titleEl.textContent = '–ó–∞–¥–∞—á–∞';
    textEl.textContent = p.text;
    knownEl.textContent = getKnownText(p);
    unknownEl.textContent = getUnknownText(p);
    explanationEl.textContent = '';
    feedback.textContent = '';
    answerInput.value = '';
    helpPrompts.innerHTML = '';
    if(helpModeEl.checked) renderHelpPrompts(p);
    answerInput.focus();
  }

  function renderHelpPrompts(p){
    try {
      helpPrompts.innerHTML = '';
      const list = document.createElement('div'); list.className='help-list';
      const q1 = document.createElement('div'); q1.textContent = '1) –ß—Ç–æ –≤ –∑–∞–¥–∞—á–µ –¥–∞–Ω–æ?'; list.appendChild(q1);
      const q2 = document.createElement('div'); q2.textContent = '2) –ß—Ç–æ —Ç—Ä–µ–±—É–µ—Ç—Å—è –Ω–∞–π—Ç–∏?'; list.appendChild(q2);
      const q3 = document.createElement('div'); q3.textContent = '3) –ö–∞–∫–∞—è –æ–ø–µ—Ä–∞—Ü–∏—è –Ω—É–∂–Ω–∞: + –∏–ª–∏ - ? –í–æ–∑–º–æ–∂–Ω–æ –¥–≤–µ –æ–ø–µ—Ä–∞—Ü–∏–∏?'; list.appendChild(q3);
      helpPrompts.appendChild(list);
    } catch(err){
      console.error('renderHelpPrompts error:', err);
      helpPrompts.innerHTML = '';
    }
  }

  function generate(){ const lvl = Number(levelEl.value); if(lvl===1) renderProblem(genLevel1()); else if(lvl===2) renderProblem(genLevel2()); else renderProblem(genLevel3()); }

  function check(){ const val = parseInt(answerInput.value||''); if(Number.isNaN(val)){ feedback.className='feedback error'; feedback.textContent='–í–≤–µ–¥–∏—Ç–µ —á–∏—Å–ª–æ –≤ –ø–æ–ª–µ –æ—Ç–≤–µ—Ç–∞.'; return; }
    if(val === current.solution){ feedback.className='feedback success'; feedback.textContent='–í–µ—Ä–Ω–æ!'; onCorrect(); }
    else { feedback.className='feedback error'; feedback.textContent='–ù–µ–≤–µ—Ä–Ω–æ ‚Äî —Å–º. –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ.'; showExplanation(); onWrong(); }
  }

  function showExplanation(){ explanationEl.innerHTML = '<strong>–†–µ—à–µ–Ω–∏–µ:</strong><br>' + (current.model ? ('–ú–æ–¥–µ–ª—å: ' + current.model + '<br>') : '') + (current.steps ? current.steps.join('<br>') : ''); }

  function onCorrect(){ saveResult(true); seriesCurrent +=1; updateProgress(); setTimeout(()=>{ generate(); }, 700); }
  function onWrong(){ saveResult(false); }

  function saveResult(ok){ let streakNow = parseInt(localStorage.getItem('wp_streak')||'0',10)||0; let bestNow = parseInt(localStorage.getItem('wp_best')||'0',10)||0; if(ok){ streakNow +=1; if(streakNow>bestNow) bestNow = streakNow; } else streakNow = 0; localStorage.setItem('wp_streak',String(streakNow)); localStorage.setItem('wp_best',String(bestNow)); localStorage.setItem('wp_student', student.value||''); best.textContent = bestNow>0?('‚òÖ'.repeat(Math.min(bestNow,3))):'‚Äî'; resultSummary.textContent = '–ü–æ—Å–ª–µ–¥–Ω–∏–π: '+(ok?'–ø—Ä–∞–≤–∏–ª—å–Ω–æ':'–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ')+'. –°–µ—Ä–∏—è: '+streakNow+'. –õ—É—á—à–µ–µ: '+bestNow+'.'; }

  function onNext(){ generate(); }

  function updateProgress(){ seriesTotal = Math.max(1, parseInt(seriesCountEl.value||'8',10)); progressEl.textContent = seriesCurrent + '/' + seriesTotal; }

  // events
  checkBtn.addEventListener('click', check);
  showBtn.addEventListener('click', ()=>{ showExplanation(); });
  nextBtn.addEventListener('click', onNext);
  skipBtn.addEventListener('click', ()=>{ saveResult(false); generate(); });
  levelEl.addEventListener('change', ()=>{ seriesCurrent=0; updateProgress(); generate(); });
  helpModeEl.addEventListener('change', ()=>{ if(helpModeEl.checked) renderHelpPrompts(current); else helpPrompts.innerHTML=''; });
  document.addEventListener('keydown',(e)=>{ if(e.key==='Enter'){ check(); } if(e.key==='n'){ generate(); } });

  // init
  generate();
})();
</script>
</body>
</html>
