<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>–ü–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑ –¥–µ—Å—è—Ç–æ–∫ ‚Äî –¢—Ä–µ–Ω–∞–∂—ë—Ä (–¥–æ 100)</title>
  <meta name="description" content="–£–ø—Ä–∞–∂–Ω–µ–Ω–∏—è –Ω–∞ —Å–ª–æ–∂–µ–Ω–∏–µ –∏ –≤—ã—á–∏—Ç–∞–Ω–∏–µ —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º —á–µ—Ä–µ–∑ –¥–µ—Å—è—Ç–æ–∫ (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 100). –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –¥–µ—Å—è—Ç–∫–æ–≤ –∏ –µ–¥–∏–Ω–∏—Ü, –ø–æ—à–∞–≥–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏."/>
  <style>
    :root{
      --bg:#f7fbff; --card:#fff; --accent:#2b8cff; --muted:#6b7280;
      --success:#2aa653; --error:#e03d3d; --touch:56px;
    }
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; padding:14px; background:var(--bg); color:#0f172a}
    header{display:flex;gap:12px;align-items:center;max-width:980px;margin:0 auto 12px}
    .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7cc4ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
    h1{font-size:1.1rem;margin:0}
    .meta{color:var(--muted);font-size:0.9rem}
    main{max-width:980px;margin:0 auto;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 6px 20px rgba(15,23,42,0.06)}
    .controls{display:flex;flex-direction:column;gap:8px}
    .controls-row{display:flex;gap:8px;align-items:center}
    select,input,button{padding:10px;border-radius:10px;border:1px solid #dbeafe;background:white;font-size:1rem}
    .right{margin-left:auto;color:var(--muted)}
    .game{display:flex;flex-direction:column;gap:12px}
    .panel{padding:12px;border-radius:12px;background:linear-gradient(180deg,#fbfdff,#fff);border:1px solid #eef2ff}
    .task{font-size:1.6rem;font-weight:800;text-align:center}
    /* numeric line (0..100) */
    .numline-wrap{padding:12px}
    .numline{position:relative;height:96px;background:linear-gradient(180deg,#f6f9ff,#fff);border-radius:10px;border:1px solid #e6eefc;padding:12px}
    .ticks{display:flex;justify-content:space-between;align-items:flex-end;height:100%}
    .tick{flex:1;text-align:center;font-weight:700;position:relative}
    .tick:before{content:'';display:block;margin:0 auto 6px;width:2px;height:16px;background:#cbd5ff;border-radius:2px}
    .tick span{display:block;margin-top:6px;font-size:0.85rem;color:#0f172a}
    .ball{position:absolute;bottom:16px;left:0;width:40px;height:40px;border-radius:50%;background:linear-gradient(180deg,#ffd66b,#ffb84a);display:flex;align-items:center;justify-content:center;font-weight:800;color:#1b1b1b;transform:translateX(-50%);transition:left 300ms cubic-bezier(.2,.9,.2,1)}
    /* tens/ones visualization */
    .viz{display:flex;gap:14px;align-items:flex-start;justify-content:center;margin-top:10px;flex-wrap:wrap}
    .bundle{display:flex;flex-direction:column;align-items:center;gap:8px}
    .bundle .label{color:var(--muted);font-size:0.9rem}
    .tens-row{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
    .ten{width:20px;height:48px;background:#ffd88a;border-radius:4px;box-shadow:0 1px 0 rgba(0,0,0,0.06)}
    .ones-row{display:flex;gap:6px;flex-wrap:wrap;justify-content:center}
    .one{width:18px;height:18px;background:#9be7ff;border-radius:4px}
    .controls-touch{display:flex;gap:8px;justify-content:center;align-items:center;margin-top:8px}
    .big-btn{padding:12px 18px;border-radius:12px;border:1px solid #dbeafe;background:white;font-size:1.03rem;min-width:86px}
    .actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:center;margin-top:10px}
    .feedback{min-height:56px;font-weight:700;text-align:center;margin-top:8px}
    .feedback.success{color:var(--success)}
    .feedback.error{color:var(--error)}
    .hint{color:var(--muted);font-size:0.95rem;text-align:center}
    .steps{margin-top:10px;background:#fbfdff;border:1px solid #eef6ff;padding:10px;border-radius:10px;color:#16325c}
    .kbd-hint{font-size:0.85rem;color:var(--muted);margin-top:8px;text-align:center}
    @media(min-width:880px){ .controls{flex-direction:row} .game{flex-direction:row;gap:18px} .panel{flex:1} }
    .sr-only{position:absolute;width:1px;height:1px;padding:0;margin:-1px;overflow:hidden;clip:rect(0,0,0,0);white-space:nowrap;border:0}
  </style>
</head>
<body>

<a href="index.html" class="home-btn">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>
<style>
  .home-btn {
    display: inline-block;
    margin: 10px;
    padding: 12px 18px;
    font-size: 18px;
    background-color: #4CAF50;
    color: white;
    border-radius: 8px;
    text-decoration: none;
  }
  .home-btn:hover {
    background-color: #45a049;
  }
</style>
  <header>
    <div class="logo">–ú2</div>
    <div>
      <h1>–ü–µ—Ä–µ—Ö–æ–¥ —á–µ—Ä–µ–∑ –¥–µ—Å—è—Ç–æ–∫ (–¥–æ 100)</h1>
      <div class="meta">–°–ª–æ–∂–µ–Ω–∏–µ –∏ –≤—ã—á–∏—Ç–∞–Ω–∏–µ —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º/–∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏–µ–º. –ü–æ—à–∞–≥–æ–≤—ã–µ –ø–æ–¥—Å–∫–∞–∑–∫–∏.</div>
    </div>
  </header>

  <main>
    <div class="controls" role="region" aria-label="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ">
      <div class="controls-row">
        <label for="level" class="sr-only">–£—Ä–æ–≤–µ–Ω—å</label>
        <select id="level" aria-label="–£—Ä–æ–≤–µ–Ω—å">
          <option value="1">1 ‚Äî –ø—Ä–æ—Å—Ç—ã–µ —Å–ª—É—á–∞–∏ (–Ω–∞–ø—Ä. 27 + 5)</option>
          <option value="2">2 ‚Äî –ø—Ä–∏–º–µ—Ä—ã –¥–æ 100 —Å –ø–µ—Ä–µ–Ω–æ—Å–æ–º</option>
          <option value="3">3 ‚Äî —Ü–µ–ø–æ—á–∫–∞ –∑–∞–¥–∞—á (—Å–ª—É—á–∞–π–Ω—ã–µ)</option>
        </select>

        <label for="seriesCount" class="sr-only">–î–ª–∏–Ω–∞ —Å–µ—Ä–∏–∏</label>
        <input id="seriesCount" type="number" min="1" max="50" value="10" style="width:96px" aria-label="–î–ª–∏–Ω–∞ —Å–µ—Ä–∏–∏">

        <div class="right">–õ—É—á—à–∏–π: <span id="best">‚Äî</span></div>
      </div>

      <div class="controls-row">
        <input id="student" placeholder="–ò–º—è —É—á–µ–Ω–∏–∫–∞ (–ª–æ–∫–∞–ª—å–Ω–æ)" style="flex:1">
        <div class="right">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="progress">0/10</span></div>
      </div>
    </div>

    <section class="game" aria-labelledby="gameHeading">
      <article class="panel">
        <div class="task" id="taskText">‚Äî</div>

        <div class="numline-wrap" aria-hidden="false">
          <div class="numline" id="numline" aria-hidden="false">
            <div class="ticks" id="ticks"></div>
            <div class="ball" id="ball">0</div>
          </div>
        </div>

        <div class="viz" aria-hidden="false">
          <div class="bundle">
            <div class="label">–î–µ—Å—è—Ç–∫–∏</div>
            <div class="tens-row" id="tensRow" aria-live="polite"></div>
            <div class="label" id="tensCount">0</div>
          </div>
          <div class="bundle">
            <div class="label">–ï–¥–∏–Ω–∏—Ü—ã</div>
            <div class="ones-row" id="onesRow" aria-live="polite"></div>
            <div class="label" id="onesCount">0</div>
          </div>
        </div>

        <div class="controls-touch" aria-hidden="false">
          <button class="big-btn" id="backBtn">‚óÄÔ∏é –ù–∞–∑–∞–¥</button>
          <div style="min-width:12px"></div>
          <button class="big-btn" id="forwardBtn">–í–ø–µ—Ä—ë–¥ ‚ñ∂Ô∏é</button>
        </div>

        <div class="kbd-hint">–ö–ª–∞–≤–∏—à–∏: ‚Üê ‚Üí ‚Äî –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ, –≤–≤–æ–¥ —Ü–∏—Ñ—Ä ‚Äî –ø–µ—Ä–µ–π—Ç–∏ –∫ —á–∏—Å–ª—É, Enter ‚Äî –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</div>

        <div class="actions">
          <button id="checkBtn">–ü—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
          <button id="showBtn">–ü–æ–∫–∞–∑–∞—Ç—å –æ—Ç–≤–µ—Ç</button>
          <button id="nextBtn">–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å</button>
        </div>

        <div class="timer" style="text-align:center;margin-top:8px">–í—Ä–µ–º—è: <span id="time">0</span> —Å</div>

        <div id="feedback" class="feedback" role="status" aria-live="polite">&nbsp;</div>

        <div class="steps" id="steps" hidden aria-live="polite"></div>
      </article>

      <aside class="panel" style="width:320px">
        <h3 style="margin-top:0">–ü–æ–¥—Å–∫–∞–∑–∫–∏</h3>
        <ul style="color:var(--muted)">
          <li>–î–æ–±–∞–≤–ª—è–µ–º –µ–¥–∏–Ω–∏—Ü—ã, –∑–∞—Ç–µ–º –ø–µ—Ä–µ–Ω–æ—Å–∏–º 10 –µ–¥–∏–Ω–∏—Ü –≤ 1 –¥–µ—Å—è—Ç–æ–∫, –µ—Å–ª–∏ –Ω—É–∂–Ω–æ.</li>
          <li>–ü—Ä–∏ –≤—ã—á–∏—Ç–∞–Ω–∏–∏ ‚Äî –∑–∞–∏–º—Å—Ç–≤—É–µ–º 1 –¥–µ—Å—è—Ç–æ–∫ –∏ –ø—Ä–∏–±–∞–≤–ª—è–µ–º 10 –µ–¥–∏–Ω–∏—Ü –∫ –µ–¥–∏–Ω–∏—Ü–∞–º.</li>
          <li>–£—Ä–æ–≤–µ–Ω—å 3 ‚Äî —Å–µ—Ä–∏—è –∑–∞–¥–∞—á —Å —Ç–∞–π–º–µ—Ä–æ–º.</li>
        </ul>

        <div style="margin-top:12px">–†–µ–∑—É–ª—å—Ç–∞—Ç:
          <div id="resultSummary" style="margin-top:8px;color:var(--muted)">‚Äî</div>
        </div>
      </aside>
    </section>
  </main>

  <footer style="max-width:980px;margin:12px auto 0;color:var(--muted)">–£–ø—Ä–∞–∂–Ω–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–∞–Ω–æ –Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–º–µ: –ú–æ—Ä–æ –ú.–ò., –ë–∞–Ω—Ç–æ–≤–∞ –ú.–ê., –ë–µ–ª—å—Ç—é–∫–æ–≤–∞ –ì.–í. ‚Äî ¬´–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞. 2 –∫–ª–∞—Å—Å¬ª.</footer>

<script>
(function(){
  // DOM
  const levelEl = document.getElementById('level');
  const taskText = document.getElementById('taskText');
  const ticksEl = document.getElementById('ticks');
  const numline = document.getElementById('numline');
  const ball = document.getElementById('ball');
  const backBtn = document.getElementById('backBtn');
  const forwardBtn = document.getElementById('forwardBtn');
  const checkBtn = document.getElementById('checkBtn');
  const showBtn = document.getElementById('showBtn');
  const nextBtn = document.getElementById('nextBtn');
  const feedback = document.getElementById('feedback');
  const student = document.getElementById('student');
  const best = document.getElementById('best');
  const seriesCountEl = document.getElementById('seriesCount');
  const progressEl = document.getElementById('progress');
  const timerEl = document.getElementById('time');
  const stepsEl = document.getElementById('steps');
  const tensRow = document.getElementById('tensRow');
  const onesRow = document.getElementById('onesRow');
  const tensCount = document.getElementById('tensCount');
  const onesCount = document.getElementById('onesCount');
  const resultSummary = document.getElementById('resultSummary');

  // state
  let a = 0, b = 0, op = '+', answer = 0;
  const minVal = 0, maxVal = 100;
  let ballPos = 0;

  // series/timer
  let seriesTotal = Math.max(1, parseInt(seriesCountEl.value||'10',10));
  let seriesCurrent = 0;
  let startTime = null, timerId = null;
  const advanceDelay = 560;

  // input buffer
  let numBuffer = '', numBufferTimer = null;
  const numBufferTimeout = 900;

  // steps auto-hide timeout (show a bit longer as requested)
  let stepsTimeout = null;
  const stepsDisplayMs = 4000;

  // localStorage restore
  student.value = localStorage.getItem('carry_student') || '';
  const storedBest = parseInt(localStorage.getItem('carry_best')||'0',10) || 0;
  best.textContent = storedBest>0?('‚òÖ'.repeat(Math.min(storedBest,3))):'‚Äî';

  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

  // build ticks 0..100 but show label every 10
  function buildTicks(){
    ticksEl.innerHTML = '';
    const steps = 100;
    for(let i=0;i<=steps;i++){
      const d = document.createElement('div'); d.className='tick';
      // show label every 10
      const label = document.createElement('span');
      label.textContent = (i % 10 === 0) ? i : '';
      d.appendChild(label);
      ticksEl.appendChild(d);
    }
  }

  // place ball by interpolating between centers of first and last ticks (robust to resize)
  function placeBall(pos){
    ballPos = Math.max(minVal, Math.min(maxVal, Math.round(pos)));
    const ticks = ticksEl.querySelectorAll('.tick');
    if(ticks.length >= 2){
      const containerRect = numline.getBoundingClientRect();
      const firstRect = ticks[0].getBoundingClientRect();
      const lastRect = ticks[ticks.length-1].getBoundingClientRect();
      const firstCenter = (firstRect.left + firstRect.right)/2 - containerRect.left;
      const lastCenter = (lastRect.left + lastRect.right)/2 - containerRect.left;
      const pct = (ballPos - minVal) / (maxVal - minVal);
      const x = firstCenter + pct * (lastCenter - firstCenter);
      ball.style.left = x + 'px';
    }
    ball.textContent = ballPos;
    renderViz(ballPos);
  }

  // render tens and ones visual for any value 0..100
  function renderViz(value){
    const t = Math.floor(value/10);
    const o = value % 10;
    tensRow.innerHTML = ''; onesRow.innerHTML = '';
    // limit to reasonable count for rendering (we show tens up to 10)
    for(let i=0;i<t;i++){
      const el = document.createElement('div'); el.className='ten'; tensRow.appendChild(el);
    }
    for(let i=0;i<o;i++){
      const el = document.createElement('div'); el.className='one'; onesRow.appendChild(el);
    }
    tensCount.textContent = t + ' –¥–µ—Å—è—Ç–∫–æ–≤';
    onesCount.textContent = o + ' –µ–¥–∏–Ω–∏—Ü';
  }

  // generate tasks depending on level
  function genTask(){
    // clear steps and any pending timeout when a new task appears
    // stepsEl.hidden = true;
    // if(stepsTimeout){ clearTimeout(stepsTimeout); stepsTimeout = null; }

    const lvl = Number(levelEl.value);
    if(lvl === 1){
      op = Math.random()<0.7?'+':'-';
      if(op === '+'){
        a = randInt(10,90);
        b = randInt(1,9);
        if(a + b > 100) a = a - (a + b - 100);
        answer = a + b;
      } else {
        b = randInt(1,9);
        a = randInt(10,99);
        if(a - b < 0) { let t=a; a = b; b = t; }
        answer = a - b;
      }
    } else if(lvl === 2){
      op = Math.random()<0.6?'+':'-';
      if(op === '+'){
        do { a = randInt(10,90); b = randInt(1,20); } while( ((a%10) + (b%10) < 10) || (a + b > 100) );
        answer = a + b;
      } else {
        do { a = randInt(10,99); b = randInt(1,9); } while( (a - b) < 0 || (a % 10) >= b );
        answer = a - b;
      }
    } else {
      op = Math.random()<0.5?'+':'-';
      if(op === '+'){
        do { a = randInt(10,90); b = randInt(1,20); } while(a + b > 100);
        answer = a + b;
      } else {
        b = randInt(1,20);
        do { a = randInt(10,100); } while(a - b < 0);
        answer = a - b;
      }
    }

    taskText.textContent = (op === '+') ? (a + ' + ' + b) : (a + ' ‚àí ' + b);
    placeBall(a);
    feedback.textContent = '';
    updateProgress();
    resetTimerIfSeries();
  }

  // compute step-by-step explanation for addition or subtraction
  function explainSteps(){
    const t = Math.floor(a/10), o = a%10;
    if(op === '+'){
      const onesSum = o + b;
      if(onesSum < 10){
        stepsEl.hidden = false;
        stepsEl.innerHTML = `<strong>–•–æ–¥ —Ä–µ—à–µ–Ω–∏—è:</strong> –°–ª–æ–∂–∏–ª–∏ –µ–¥–∏–Ω–∏—Ü—ã: ${o} + ${b} = ${onesSum}. –ù–∏—á–µ–≥–æ –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è. –ò—Ç–æ–≥: ${answer}.`;
      } else {
        const carry = Math.floor(onesSum/10);
        const onesAfter = onesSum % 10;
        const tensAfter = t + carry;
        stepsEl.hidden = false;
        stepsEl.innerHTML = `<strong>–•–æ–¥ —Ä–µ—à–µ–Ω–∏—è:</strong>
          1) –°–ª–æ–∂–∏–ª–∏ –µ–¥–∏–Ω–∏—Ü—ã: ${o} + ${b} = ${onesSum}. <br>
          2) –ò–∑ ${onesSum} –≤—ã–¥–µ–ª—è–µ–º 10 ‚Üí –ø–µ—Ä–µ–Ω–æ—Å: +${carry} –∫ –¥–µ—Å—è—Ç–∫–∞–º, –æ—Å—Ç–∞—ë—Ç—Å—è ${onesAfter} –µ–¥–∏–Ω–∏—Ü. <br>
          3) –î–µ—Å—è—Ç–∫–∏: ${t} + ${carry} = ${tensAfter}. –ò—Ç–æ–≥–æ: ${tensAfter} –¥–µ—Å—è—Ç–∫–æ–≤ –∏ ${onesAfter} –µ–¥–∏–Ω–∏—Ü ‚Üí ${answer}.`;
      }
    } else {
      const tA = Math.floor(a/10), oA = a%10;
      if(oA >= b){
        stepsEl.hidden = false;
        stepsEl.innerHTML = `<strong>–•–æ–¥ —Ä–µ—à–µ–Ω–∏—è:</strong> –í—ã—á–ª–∏ –µ–¥–∏–Ω–∏—Ü—ã: ${oA} ‚àí ${b} = ${oA - b}. –î–µ—Å—è—Ç–∫–∏: ${tA}. –ò—Ç–æ–≥–æ: ${answer}.`;
      } else {
        const borrowed = 1;
        const onesAfter = (oA + 10) - b;
        const tensAfter = tA - borrowed;
        stepsEl.hidden = false;
        stepsEl.innerHTML = `<strong>–•–æ–¥ —Ä–µ—à–µ–Ω–∏—è:</strong>
          1) –í A –µ–¥–∏–Ω–∏—Ü –±—ã–ª–æ ${oA}, –∞ –Ω—É–∂–Ω–æ –≤—ã—á–µ—Å—Ç—å ${b} ‚Üí –∑–∞–∏–º—Å—Ç–≤—É–µ–º 1 –¥–µ—Å—è—Ç–æ–∫ (=10 –µ–¥–∏–Ω–∏—Ü). <br>
          2) –¢–µ–ø–µ—Ä—å –µ–¥–∏–Ω–∏—Ü: ${oA + 10} ‚àí ${b} = ${onesAfter}. <br>
          3) –î–µ—Å—è—Ç–∫–∏: ${tA} ‚àí 1 = ${tensAfter}. –ò—Ç–æ–≥–æ: ${tensAfter} –¥–µ—Å—è—Ç–∫–æ–≤ –∏ ${onesAfter} –µ–¥–∏–Ω–∏—Ü ‚Üí ${answer}.`;
      }
    }

    // auto-hide steps after a longer delay so —É—á–µ–Ω–∏–∫ —É—Å–ø–µ–µ—Ç –ø—Ä–æ—á–∏—Ç–∞—Ç—å
    if(stepsTimeout) clearTimeout(stepsTimeout);
    stepsTimeout = setTimeout(()=>{ stepsEl.hidden = true; stepsTimeout = null; }, stepsDisplayMs);
  }

  function checkAnswer(){
    if(ballPos === answer){
      feedback.className = 'feedback success';
      feedback.textContent = '–ü—Ä–∞–≤–∏–ª—å–Ω–æ! ' + (op==='+' ? (a+'+'+b+'='+answer) : (a+'‚àí'+b+'='+answer));
      explainSteps();
      saveResult(true);
      seriesCurrent += 1; updateProgress();
      if(seriesCurrent >= seriesTotal){ setTimeout(endSeries, advanceDelay); stopTimer(); }
      else setTimeout(()=>{ genTask(); }, advanceDelay);
    } else {
      const crossed = (op==='+' && ((a%10)+(b%10) >= 10)) || (op==='-' && ((a%10) < b));
      if(crossed){
        feedback.className='feedback error';
        feedback.textContent = '–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ. –ó–¥–µ—Å—å –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–µ—Ä–µ–Ω–æ—Å/–∑–∞–∏–º—Å—Ç–≤–æ–≤–∞–Ω–∏–µ ‚Äî –ø–æ—Å–º–æ—Ç—Ä–∏—Ç–µ –ø–æ–¥—Å–∫–∞–∑–∫—É.';
        explainSteps();
      } else {
        feedback.className='feedback error';
        feedback.textContent = '–ù–µ–≤–µ—Ä–Ω–æ, –ø–æ–ø—Ä–æ–±—É–π –µ—â—ë.';
      }
      saveResult(false);
    }
  }

  function showAnswer(){ placeBall(answer); feedback.className=''; feedback.textContent = '–ü–æ–∫–∞–∑–∞–Ω –æ—Ç–≤–µ—Ç: ' + answer; explainSteps(); }
  function skipTask(){ genTask(); }

  // statistics
  function saveResult(ok){
    let streak = parseInt(localStorage.getItem('carry_streak')||'0',10);
    let bestv = parseInt(localStorage.getItem('carry_best')||'0',10) || 0;
    if(ok){ streak += 1; if(streak > bestv) bestv = streak; } else streak = 0;
    localStorage.setItem('carry_streak', String(streak));
    localStorage.setItem('carry_best', String(bestv));
    localStorage.setItem('carry_student', student.value || '');
    best.textContent = bestv>0?('‚òÖ'.repeat(Math.min(bestv,3))):'‚Äî';
    resultSummary.textContent = '–ü–æ—Å–ª–µ–¥–Ω–∏–π: ' + (ok ? '–ø—Ä–∞–≤–∏–ª—å–Ω–æ' : '–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ') + '. –°–µ—Ä–∏—è: ' + streak + '. –õ—É—á—à–µ–µ: ' + bestv + '.';
  }

  function endSeries(){
    feedback.className='feedback success';
    feedback.textContent = '–°–µ—Ä–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö: ' + seriesCurrent + '/' + seriesTotal + '.';
    disableAll(true);
  }
  function disableAll(d){
    backBtn.disabled = d; forwardBtn.disabled = d; checkBtn.disabled = d; showBtn.disabled = d; nextBtn.disabled = d;
    seriesCountEl.disabled = d; levelEl.disabled = d;
  }

  // timer for level 3
  function startTimer(){ if(timerId) return; startTime = Date.now(); timerId = setInterval(()=>{ const s = Math.floor((Date.now() - startTime)/1000); timerEl.textContent = s; },1000); }
  function stopTimer(){ if(timerId){ clearInterval(timerId); timerId = null; } }
  function resetTimerIfSeries(){ if(Number(levelEl.value) === 3){ stopTimer(); timerEl.textContent = '0'; startTimer(); } else { stopTimer(); timerEl.textContent = '0'; } }

  // progress
  function updateProgress(){ seriesTotal = Math.max(1, parseInt(seriesCountEl.value||'10',10)); progressEl.textContent = seriesCurrent + '/' + seriesTotal; }

  function resetSeries(){ seriesCurrent = 0; updateProgress(); disableAll(false); genTask(); }

  // input buffer commit
  function commitNumBuffer(){
    if(numBuffer.length === 0) return;
    let v = parseInt(numBuffer,10);
    if(Number.isNaN(v)){ numBuffer = ''; return; }
    v = Math.max(minVal, Math.min(maxVal, v));
    placeBall(v);
    numBuffer = '';
  }

  function clearNumBuffer(){ if(numBufferTimer){ clearTimeout(numBufferTimer); numBufferTimer = null; } numBuffer = ''; }

  // events
  backBtn.addEventListener('click', ()=>{ placeBall(ballPos-1); clearNumBuffer(); });
  forwardBtn.addEventListener('click', ()=>{ placeBall(ballPos+1); clearNumBuffer(); });
  checkBtn.addEventListener('click', checkAnswer);
  showBtn.addEventListener('click', showAnswer);
  nextBtn.addEventListener('click', skipTask);
  levelEl.addEventListener('change', ()=>{ resetSeries(); });
  seriesCountEl.addEventListener('change', ()=>{ resetSeries(); });

  // keyboard
  document.addEventListener('keydown', (e) => {
    if(e.key === 'ArrowRight'){ e.preventDefault(); placeBall(ballPos+1); clearNumBuffer(); }
    else if(e.key === 'ArrowLeft'){ e.preventDefault(); placeBall(ballPos-1); clearNumBuffer(); }
    else if(e.key === 'Enter'){ e.preventDefault(); commitNumBuffer(); checkAnswer(); }
    else if(/^[0-9]$/.test(e.key)){
      numBuffer += e.key;
      if(numBuffer.length > 3) numBuffer = numBuffer.slice(-3);
      const v = parseInt(numBuffer,10);
      if(!Number.isNaN(v)) placeBall(Math.max(minVal, Math.min(maxVal, v)));
      if(numBufferTimer) clearTimeout(numBufferTimer);
      numBufferTimer = setTimeout(()=>{ commitNumBuffer(); numBufferTimer = null; }, numBufferTimeout);
    }
  });

  // init
  buildTicks();
  resetSeries();
  window.addEventListener('resize', ()=>{ placeBall(ballPos); });

})();
</script>
</body>
</html>
