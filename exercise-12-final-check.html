<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>–ò—Ç–æ–≥–æ–≤—ã–π —Ç–µ—Å—Ç ‚Äî –ú–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª—å (2 –∫–ª–∞—Å—Å)</title>
<meta name="description" content="–ö–æ—Ä–æ—Ç–∫–∞—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è (10‚Äì15 –≤–æ–ø—Ä–æ—Å–æ–≤) –ø–æ —Ç–µ–º–∞–º: —á–∏—Å–ª–∞, –æ–ø–µ—Ä–∞—Ü–∏–∏, —Ä–∞–∑—Ä—è–¥—ã, —Å–º/–¥–º, –∑–∞–¥–∞—á–∏, –≥–µ–æ–º–µ—Ç—Ä–∏—è –∏ –¥–µ–Ω—å–≥–∏.">
<style>
  :root{
    --bg:#f6fbff; --card:#fff; --accent:#2b8cff; --muted:#6b7280; --ok:#2aa653; --err:#e03d3d;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;padding:12px;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:#071029}
  a.home-btn{display:inline-block;margin:8px 0;padding:10px 14px;font-size:15px;background:#4CAF50;color:white;border-radius:8px;text-decoration:none}
  header{display:flex;gap:12px;align-items:center;max-width:1100px;margin:6px auto 12px}
  .logo{width:44px;height:44px;border-radius:10px;background:linear-gradient(135deg,var(--accent),#7cc4ff);display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700}
  h1{font-size:1.05rem;margin:0}
  .meta{color:var(--muted);font-size:0.9rem}
  main{max-width:1100px;margin:0 auto;background:var(--card);padding:12px;border-radius:12px;box-shadow:0 8px 30px rgba(15,23,42,0.06)}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin-bottom:8px}
  label{font-size:0.95rem}
  select,input[type="number"],button{padding:8px;border-radius:8px;border:1px solid #dbeafe;background:white}
  .panel{padding:10px;border-radius:10px;background:#fff}
  .qcard{margin:10px 0;padding:12px;border-radius:10px;border:1px solid #eef6ff;background:#fbfdff}
  .qtitle{font-weight:800;margin-bottom:8px}
  .qbody{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .answer{margin-top:8px}
  .nav{display:flex;gap:8px;justify-content:center;margin-top:12px}
  .status{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-top:8px}
  .stat{padding:8px;border-radius:8px;background:#fbfdff;border:1px solid #eef6ff}
  .result{margin-top:12px;padding:12px;border-radius:10px;background:#fff}
  .explain{margin-top:8px;padding:10px;border-radius:8px;background:#fffbe8;border:1px solid #ffd96b}
  .print-link{display:inline-block;margin-top:8px;padding:8px 12px;background:#111827;color:white;border-radius:8px;text-decoration:none}
  .small{font-size:0.92rem;padding:8px 10px}
  @media(min-width:880px){ .qbody{align-items:flex-start} .controls{flex-wrap:nowrap} }
</style>
</head>
<body>
  <a href="index.html" class="home-btn">üè† –ù–∞ –≥–ª–∞–≤–Ω—É—é</a>

  <header>
    <div class="logo">M2</div>
    <div>
      <h1>–ò—Ç–æ–≥–æ–≤—ã–π —Ç–µ—Å—Ç ‚Äî –º–∏–∫—Ä–æ–∫–æ–Ω—Ç—Ä–æ–ª—å</h1>
      <div class="meta">–ö–æ—Ä–æ—Ç–∫–∞—è –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∞—è –ø–æ –≤—Å–µ–º –ø—Ä–æ–π–¥–µ–Ω–Ω—ã–º —Ç–µ–º–∞–º. –ü–æ–¥—Å–∫–∞–∑–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã ‚Äî –æ–±—ä—è—Å–Ω–µ–Ω–∏—è –ø–æ—è–≤—è—Ç—Å—è –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è.</div>
    </div>
  </header>

  <main>
    <div class="panel">
      <div class="controls" role="region" aria-label="–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ç–µ—Å—Ç–∞">
        <label>–í–æ–ø—Ä–æ—Å–æ–≤:
          <select id="numQuestions">
            <option value="10">10</option>
            <option value="11">11</option>
            <option value="12" selected>12</option>
            <option value="13">13</option>
            <option value="14">14</option>
            <option value="15">15</option>
          </select>
        </label>

        <label><input type="checkbox" id="useTimer"> –í–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä</label>
        <label>–õ–∏–º–∏—Ç (–º–∏–Ω): <input id="timeLimit" type="number" min="1" max="60" value="10" style="width:76px"></label>

        <div style="margin-left:auto" class="status">
          <div class="stat">–ü—Ä–æ–≥—Ä–µ—Å—Å: <span id="progress">0/0</span></div>
          <div class="stat">–í—Ä–µ–º—è: <span id="timer">00:00</span></div>
        </div>
      </div>

      <div id="testArea" aria-live="polite">
        <!-- –≤–æ–ø—Ä–æ—Å –±—É–¥–µ—Ç –≤—Å—Ç–∞–≤–ª–µ–Ω —Å—é–¥–∞ -->
      </div>

      <div class="nav" id="navButtons">
        <button id="prevBtn" class="small">‚óÄ –ù–∞–∑–∞–¥</button>
        <button id="nextBtn" class="small">–í–ø–µ—Ä—ë–¥ ‚ñ∂</button>
        <button id="finishBtn" class="small">–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å</button>
        <button id="resetBtn" class="small">–ü–µ—Ä–µ—Å–æ–∑–¥–∞—Ç—å —Ç–µ—Å—Ç</button>
      </div>

      <div id="after" style="display:none" class="result" aria-live="polite">
        <h2 id="scoreTitle">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã</h2>
        <div id="scoreSummary"></div>
        <div id="detailedAnswers"></div>
        <div style="margin-top:12px">
          <button id="printBtn" class="small">–ü–µ—á–∞—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞</button>
          <a id="printOnlyLink" class="print-link" href="#" target="_blank" rel="noopener">–û—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–µ—á–∞—Ç–∏</a>
        </div>
      </div>
    </div>
  </main>

<script>
(function(){
  // ======= helpers =======
  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
  function clamp(n,a,b){ return Math.max(a,Math.min(b,n)); }
  function pad2(n){ return (n<10? '0'+n: String(n)); }

  // ======= DOM =======
  const numQuestionsEl = document.getElementById('numQuestions');
  const useTimerEl = document.getElementById('useTimer');
  const timeLimitEl = document.getElementById('timeLimit');
  const progressEl = document.getElementById('progress');
  const timerEl = document.getElementById('timer');
  const testArea = document.getElementById('testArea');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const finishBtn = document.getElementById('finishBtn');
  const resetBtn = document.getElementById('resetBtn');
  const afterDiv = document.getElementById('after');
  const scoreSummary = document.getElementById('scoreSummary');
  const detailedAnswers = document.getElementById('detailedAnswers');
  const printBtn = document.getElementById('printBtn');
  const printOnlyLink = document.getElementById('printOnlyLink');

  // ======= state =======
  let questions = []; // array of {id,type, prompt, options(optional), answer, explanation}
  let answers = {};   // id -> user answer (varies by type)
  let currentIndex = 0;
  let qCount = 12;
  let timerId = null;
  let startedAt = null;
  let elapsedSec = 0;
  let timeLimitSec = 0;
  let finished = false;

  // ======= Question generators (all natural numbers only) =======
  // We'll create a variety of question types, each returns {id, type, prompt, answer, explanation, renderAnswer(...) optional}
  let qIdCounter = 1;

  function genSostavChisla(){ // "–°–æ—Å—Ç–∞–≤ —á–∏—Å–ª–∞": give A and ask B so A+B=N? We'll ask to provide one addend.
    // choose N 2..20, pick a visible part a, ask "–°–æ—Å—Ç–∞–≤—å—Ç–µ —á–∏—Å–ª–æ N: –∫–∞–∫–æ–µ —á–∏—Å–ª–æ –Ω–∞–¥–æ –¥–æ–±–∞–≤–∏—Ç—å –∫ a?"
    const N = randInt(2,20);
    const a = randInt(1, N-1);
    const correct = N - a;
    return {
      id: qIdCounter++,
      type: 'number',
      topic: '–°–æ—Å—Ç–∞–≤ —á–∏—Å–ª–∞',
      prompt: `–°–æ—Å—Ç–∞–≤ —á–∏—Å–ª–∞: —É –Ω–∞—Å –µ—Å—Ç—å ${a} –∏ –µ—â—ë —Å–∫–æ–ª—å–∫–æ –Ω—É–∂–Ω–æ, —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏–ª–æ—Å—å ${N}?`,
      answer: correct,
      explanation: `${a} + ${correct} = ${N}.`
    };
  }

  function genComparison(){ // "–ë–æ–ª—å—à–µ-–º–µ–Ω—å—à–µ": compare two numbers
    const a = randInt(1,99);
    const b = randInt(1,99);
    const op = a===b ? '=' : (a>b ? '>' : '<');
    return {
      id: qIdCounter++,
      type: 'choice',
      topic: '–°—Ä–∞–≤–Ω–µ–Ω–∏–µ',
      prompt: `–ß—Ç–æ —Å—Ç–æ–∏—Ç –º–µ–∂–¥—É —á–∏—Å–ª–∞–º–∏ ${a} –∏ ${b}? –í—ã–±–µ—Ä–∏—Ç–µ –∑–Ω–∞–∫.`,
      options: ['<','>','='],
      answer: op,
      explanation: `–ü–æ—Ç–æ–º—É —á—Ç–æ ${a} ${op} ${b}.`
    };
  }

  function genPlaceValue(){ // –¥–µ—Å—è—Ç–∫–∏ –∏ –µ–¥–∏–Ω–∏—Ü—ã
    const n = randInt(10,99);
    const tens = Math.floor(n/10);
    const ones = n % 10;
    return {
      id: qIdCounter++,
      type: 'text',
      topic: '–î–µ—Å—è—Ç–∫–∏ –∏ –µ–¥–∏–Ω–∏—Ü—ã',
      prompt: `–ß–∏—Å–ª–æ ${n}. –°–∫–æ–ª—å–∫–æ –≤ –Ω—ë–º –¥–µ—Å—è—Ç–∫–æ–≤? (–≤–≤–µ–¥–∏—Ç–µ —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ)`,
      answer: tens,
      explanation: `${n} = ${tens} –¥–µ—Å—è—Ç–∫–æ–≤ –∏ ${ones} –µ–¥–∏–Ω–∏—Ü.`
    };
  }

  function genAddNoCarry(){ // —Å–ª–æ–∂–µ–Ω–∏–µ –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞ –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 20
    const a = randInt(1,9);
    const b = randInt(1, 9 - a + 1); // ensure a+b<=9? but no transition: ensure a%10 + b < 10 -> using 1..9 both but ensure sum<=9? For within 20 '–±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞ —á–µ—Ä–µ–∑ –¥–µ—Å—è—Ç–æ–∫' means units sum <10.
    // Simpler: choose a in 1..9, b in 1..(9 - (a%10))
    const bmax = 9 - (a % 10);
    const bb = clamp(randInt(1, Math.max(1,bmax)),1,bmax);
    return {
      id: qIdCounter++,
      type: 'number',
      topic: '–°–ª–æ–∂–µ–Ω–∏–µ –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞',
      prompt: `–í—ã—á–∏—Å–ª–∏—Ç–µ: ${a} + ${bb} = ?`,
      answer: a+bb,
      explanation: `${a} + ${bb} = ${a+bb}.`
    };
  }

  function genSubNoCarry(){ // –≤—ã—á–∏—Ç–∞–Ω–∏–µ –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞
    const a = randInt(2,20);
    const b = randInt(1, Math.min(9, a-1));
    return {
      id: qIdCounter++,
      type: 'number',
      topic: '–í—ã—á–∏—Ç–∞–Ω–∏–µ –±–µ–∑ –ø–µ—Ä–µ—Ö–æ–¥–∞',
      prompt: `–í—ã—á–∏—Å–ª–∏—Ç–µ: ${a} ‚àí ${b} = ?`,
      answer: a - b,
      explanation: `${a} ‚àí ${b} = ${a - b}.`
    };
  }

  function genAddCarry(){ // —Å–ª–æ–∂–µ–Ω–∏–µ —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º —á–µ—Ä–µ–∑ –¥–µ—Å—è—Ç–æ–∫ (–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 100)
    // choose a ‚àà [10,90], b ‚àà [1,20] ensuring ‚â§100
    const a = randInt(10,90);
    const b = randInt(1, Math.min(20, 100 - a));
    // ensure that units sum >=10 to force carry? ask examples with carry so units sum >=10
    if(((a%10) + b) < 10){
      // adjust b so carry occurs
      const need = 10 - (a%10);
      const b2 = clamp(randInt(need, Math.min(20,100 - a)), need, Math.min(20,100 - a));
      return {
        id: qIdCounter++,
        type: 'number',
        topic: '–°–ª–æ–∂–µ–Ω–∏–µ —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º',
        prompt: `–í—ã—á–∏—Å–ª–∏—Ç–µ: ${a} + ${b2} = ?`,
        answer: a + b2,
        explanation: `${a} + ${b2} = ${a + b2}.`
      };
    }
    return {
      id: qIdCounter++,
      type: 'number',
      topic: '–°–ª–æ–∂–µ–Ω–∏–µ —Å –ø–µ—Ä–µ—Ö–æ–¥–æ–º',
      prompt: `–í—ã—á–∏—Å–ª–∏—Ç–µ: ${a} + ${b} = ?`,
      answer: a + b,
      explanation: `${a} + ${b} = ${a + b}.`
    };
  }

  function genCmDm(){ // —Å–º ‚Üî –¥–º conversion
    // ask: –°–∫–æ–ª—å–∫–æ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–æ–≤ –≤ X –¥–º? choose X 1..9
    const dm = randInt(1,9);
    const correct = dm * 10;
    return {
      id: qIdCounter++,
      type: 'number',
      topic: '–°–∞–Ω—Ç–∏–º–µ—Ç—Ä—ã –∏ –¥–µ—Ü–∏–º–µ—Ç—Ä—ã',
      prompt: `–°–∫–æ–ª—å–∫–æ —Å–∞–Ω—Ç–∏–º–µ—Ç—Ä–æ–≤ –≤ ${dm} –¥–º?`,
      answer: correct,
      explanation: `1 –¥–º = 10 —Å–º, –ø–æ—ç—Ç–æ–º—É ${dm} –¥–º = ${dm} √ó 10 = ${correct} —Å–º.`
    };
  }

  function genWordProblem(){ // –ø—Ä–æ—Å—Ç–∞—è —Ç–µ–∫—Å—Ç–æ–≤–∞—è –∑–∞–¥–∞—á–∞, 1 –æ–ø–µ—Ä–∞—Ü–∏—è ‚â§20
    const a = randInt(5,20);
    const b = randInt(1, Math.min(10, a-1));
    return {
      id: qIdCounter++,
      type: 'number',
      topic: '–°–ª–æ–≤–µ—Å–Ω–∞—è –∑–∞–¥–∞—á–∞',
      prompt: `–£ –ú–∞—à–∏ –±—ã–ª–æ ${a} –ø–µ—á–µ–Ω–∏–π. –û–Ω–∞ –æ—Ç–¥–∞–ª–∞ ${b}. –°–∫–æ–ª—å–∫–æ –æ—Å—Ç–∞–ª–æ—Å—å –ø–µ—á–µ–Ω–∏–π?`,
      answer: a - b,
      explanation: `${a} ‚àí ${b} = ${a - b}.`
    };
  }

  function genTableQuestion(){ // –±—ã—Å—Ç—Ä—ã–µ –≤—ã—á–∏—Å–ª–µ–Ω–∏—è: random simple add/sub
    if(Math.random() < 0.6){
      const a = randInt(1,20);
      const b = randInt(1,20);
      return {
        id: qIdCounter++,
        type: 'number',
        topic: '–¢–∞–±–ª–∏—Ü–∞ (–±—ã—Å—Ç—Ä–æ)',
        prompt: `–í—ã—á–∏—Å–ª–∏—Ç–µ: ${a} + ${b} = ?`,
        answer: a + b,
        explanation: `${a} + ${b} = ${a + b}.`
      };
    } else {
      const a = randInt(2,20);
      const b = randInt(1,a-1);
      return {
        id: qIdCounter++,
        type: 'number',
        topic: '–¢–∞–±–ª–∏—Ü–∞ (–±—ã—Å—Ç—Ä–æ)',
        prompt: `–í—ã—á–∏—Å–ª–∏—Ç–µ: ${a} ‚àí ${b} = ?`,
        answer: a - b,
        explanation: `${a} ‚àí ${b} = ${a - b}.`
      };
    }
  }

  function genSequenceQuestion(){ // next number +1 or +2
    const step = Math.random() < 0.6 ? 1 : 2;
    const start = randInt(1, 30);
    const seq = [start, start + step, start + 2*step];
    const missingIndex = 2; // ask next
    const ans = seq[missingIndex];
    return {
      id: qIdCounter++,
      type: 'number',
      topic: '–ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏',
      prompt: `–ö–∞–∫–æ–µ —á–∏—Å–ª–æ –∏–¥—ë—Ç –¥–∞–ª—å—à–µ –≤ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏: ${seq[0]}, ${seq[1]}, ... ?`,
      answer: ans,
      explanation: `–®–∞–≥ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ ${step}, –ø–æ—ç—Ç–æ–º—É —Å–ª–µ–¥—É—é—â–µ–µ —á–∏—Å–ª–æ ${ans}.`
    };
  }

  function genGeometryPerimeter(){ // perimeter rectangle integer cm, w,h natural
    const w = randInt(2,12);
    const h = randInt(1,12);
    const per = 2*(w+h);
    return {
      id: qIdCounter++,
      type: 'number',
      topic: '–ì–µ–æ–º–µ—Ç—Ä–∏—è (–ø–µ—Ä–∏–º–µ—Ç—Ä)',
      prompt: `–ü—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ —Å–æ —Å—Ç–æ—Ä–æ–Ω–∞–º–∏ ${w} —Å–º –∏ ${h} —Å–º. –ù–∞–π–¥–∏—Ç–µ –ø–µ—Ä–∏–º–µ—Ç—Ä (–≤ —Å–º).`,
      answer: per,
      explanation: `–ü–µ—Ä–∏–º–µ—Ç—Ä = 2√ó( ${w} + ${h} ) = ${per} —Å–º.`
    };
  }

  function genMoneyQuestion(){ // payment: price and payment given -> change
    const price = randInt(1,20); // keep small for test
    // choose paid >= price using banknotes set
    const banknotes = [1,2,5,10,50,100];
    // choose a paid sum that is >=price and natural
    let paid = price;
    if(Math.random() < 0.5){
      // make some overpay by adding a random banknote
      const add = banknotes[randInt(0, banknotes.length-1)];
      paid = price + add;
    } else {
      // exact sometimes
      paid = price;
    }
    const change = paid - price;
    return {
      id: qIdCounter++,
      type: 'number',
      topic: '–î–µ–Ω—å–≥–∏ (—Å–¥–∞—á–∞)',
      prompt: `–¶–µ–Ω–∞ ${price} —Ä—É–±. –ü–æ–∫—É–ø–∞—Ç–µ–ª—å –∑–∞–ø–ª–∞—Ç–∏–ª ${paid} —Ä—É–±. –°–∫–æ–ª—å–∫–æ —Å–¥–∞—á–∏ –Ω—É–∂–Ω–æ –¥–∞—Ç—å (–≤ —Ä—É–±–ª—è—Ö)?`,
      answer: change,
      explanation: `–°–¥–∞—á–∞ = ${paid} ‚àí ${price} = ${change} —Ä—É–±.`
    };
  }

  // master generator: pick from pool to ensure coverage
  function generateQuestions(n){
    qIdCounter = 1;
    const poolGenerators = [
      genSostavChisla,
      genComparison,
      genPlaceValue,
      genAddNoCarry,
      genSubNoCarry,
      genAddCarry,
      genCmDm,
      genWordProblem,
      genTableQuestion,
      genSequenceQuestion,
      genGeometryPerimeter,
      genMoneyQuestion
    ];
    const arr = [];
    // ensure we include most types at least once if n >= pool length
    const poolLen = poolGenerators.length;
    const used = new Set();
    // try to pick diverse set
    for(let i=0;i<n;i++){
      // prefer types not yet used
      let gen;
      const remaining = poolGenerators.filter((g,idx)=> !used.has(idx));
      if(remaining.length > 0 && (n - i) <= remaining.length){
        // force include remaining
        gen = remaining[0];
        const idx = poolGenerators.indexOf(gen);
        used.add(idx);
      } else {
        gen = poolGenerators[randInt(0, poolLen-1)];
        const idx = poolGenerators.indexOf(gen);
        used.add(idx);
      }
      arr.push(gen());
    }
    return arr;
  }

  // ======= Rendering questions =======
  function renderQuestion(index){
    const q = questions[index];
    testArea.innerHTML = '';
    const container = document.createElement('div');
    container.className = 'qcard';
    const title = document.createElement('div');
    title.className = 'qtitle';
    title.textContent = `–í–æ–ø—Ä–æ—Å ${index+1} ‚Äî —Ç–µ–º–∞: ${q.topic}`;
    const body = document.createElement('div');
    body.className = 'qbody';
    const prompt = document.createElement('div');
    prompt.innerHTML = `<div>${q.prompt}</div>`;
    body.appendChild(prompt);

    // render input depending on type
    const answerDiv = document.createElement('div');
    answerDiv.className = 'answer';
    if(q.type === 'number' || q.type === 'text'){
      const input = document.createElement('input');
      input.type = 'number';
      input.inputMode = 'numeric';
      input.id = 'ans_' + q.id;
      input.style.minWidth = '110px';
      input.value = (answers[q.id] !== undefined) ? answers[q.id] : '';
      input.addEventListener('input', ()=>{ answers[q.id] = input.value.trim(); updateProgressDisplay(); });
      // keyboard: Enter moves next
      input.addEventListener('keydown', (e)=>{ if(e.key === 'Enter'){ goNext(); } });
      answerDiv.appendChild(input);
    } else if(q.type === 'choice'){
      // radio choices
      q.options.forEach(opt=>{
        const btn = document.createElement('button');
        btn.className = 'small';
        btn.type = 'button';
        btn.style.margin = '4px';
        btn.textContent = opt;
        btn.addEventListener('click', ()=>{ answers[q.id] = opt; // visually indicate selection
          Array.from(answerDiv.querySelectorAll('button')).forEach(b=>b.style.outline=''); btn.style.outline='3px solid rgba(43,140,255,0.18)';
          updateProgressDisplay();
        });
        // if previously selected, mark
        if(answers[q.id] === opt){ setTimeout(()=>btn.style.outline='3px solid rgba(43,140,255,0.18)',50); }
        answerDiv.appendChild(btn);
      });
    }

    body.appendChild(answerDiv);
    container.appendChild(title);
    container.appendChild(body);
    // small footer
    const footer = document.createElement('div');
    footer.style.marginTop = '8px';
    footer.style.color = 'var(--muted)';
    footer.textContent = `–í–æ–ø—Ä–æ—Å ID: ${q.id}`;
    container.appendChild(footer);

    testArea.appendChild(container);
    // focus first input if available
    const el = document.querySelector('#ans_' + q.id);
    if(el) el.focus();
    // update nav/pagination
    updateNav();
  }

  function updateNav(){
    progressEl.textContent = `${currentIndex+1}/${questions.length}`;
    prevBtn.disabled = currentIndex === 0;
    nextBtn.disabled = currentIndex >= questions.length - 1;
  }

  function updateProgressDisplay(){
    // count answered
    const answered = questions.reduce((acc,q)=> acc + (answers[q.id] !== undefined && answers[q.id] !== '' ? 1 : 0), 0);
    progressEl.textContent = `${answered}/${questions.length}`;
  }

  // ======= Timer =======
  function startTimer(){
    if(timerId) clearInterval(timerId);
    startedAt = Date.now();
    elapsedSec = 0;
    const enabled = useTimerEl.checked;
    if(!enabled) { timerEl.textContent = '‚Äî'; return; }
    timeLimitSec = Math.max(1, parseInt(timeLimitEl.value||'10',10)) * 60;
    timerId = setInterval(()=>{
      elapsedSec = Math.floor((Date.now() - startedAt)/1000);
      const rem = Math.max(0, timeLimitSec - elapsedSec);
      timerEl.textContent = `${pad2(Math.floor(rem/60))}:${pad2(rem%60)}`;
      if(rem <= 0){
        clearInterval(timerId);
        timerId = null;
        // auto-finish
        finishTest();
      }
    }, 300);
  }

  // ======= Navigation helpers =======
  function goPrev(){ if(currentIndex>0){ currentIndex--; renderQuestion(currentIndex); } }
  function goNext(){ if(currentIndex < questions.length -1){ currentIndex++; renderQuestion(currentIndex); } }

  // ======= Finish and checking =======
  function finishTest(){
    if(finished) return;
    finished = true;
    if(timerId){ clearInterval(timerId); timerId=null; }
    // compute score
    let correctCount = 0;
    const details = [];
    for(const q of questions){
      const userRaw = answers[q.id];
      let userVal = userRaw;
      if(q.type === 'number' || q.type === 'text'){
        // coerce to integer for comparison; empty means NaN
        userVal = (userRaw === undefined || userRaw === '') ? NaN : parseInt(userRaw,10);
      } else if(q.type === 'choice'){
        userVal = userRaw || null;
      }
      const isCorrect = (q.type === 'number' || q.type === 'text') ? (!Number.isNaN(userVal) && Number(userVal) === Number(q.answer)) : (userVal === q.answer);
      if(isCorrect) correctCount++;
      details.push({
        id: q.id, prompt: q.prompt, topic: q.topic, correct: q.answer, user: userVal, ok: isCorrect, explanation: q.explanation
      });
    }

    // show results
    testArea.style.display = 'none';
    afterDiv.style.display = '';
    const percent = Math.round(correctCount / questions.length * 100);
    scoreSummary.innerHTML = `<p>–ü—Ä–∞–≤–∏–ª—å–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤: <strong>${correctCount}/${questions.length}</strong> ‚Äî ${percent}%</p>
      <p>–í—Ä–µ–º—è: ${timerEl.textContent}</p>`;
    // detailed list
    detailedAnswers.innerHTML = '';
    details.forEach((d, idx)=>{
      const card = document.createElement('div');
      card.className = 'qcard';
      card.innerHTML = `<div class="qtitle">–í–æ–ø—Ä–æ—Å ${idx+1} ‚Äî ${d.topic}</div>
        <div>${d.prompt}</div>
        <div style="margin-top:8px"><strong>–í–∞—à –æ—Ç–≤–µ—Ç:</strong> ${d.user === null || (String(d.user)==='NaN') ? '<em>–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞</em>' : String(d.user)}</div>
        <div style="margin-top:4px"><strong>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç:</strong> ${d.correct}</div>
        <div class="explain"><strong>–ö—Ä–∞—Ç–∫–æ–µ –ø–æ—è—Å–Ω–µ–Ω–∏–µ:</strong> ${d.explanation}</div>`;
      detailedAnswers.appendChild(card);
    });

    // save best score in localStorage
    const prevBest = parseInt(localStorage.getItem('final_best')||'0',10) || 0;
    if(percent > prevBest) localStorage.setItem('final_best', String(percent));
    // prepare print page content URL
    preparePrintPage(correctCount, percent, details);
  }

  // ======= Print / export result =======
  function preparePrintPage(correctCount, percent, details){
    const title = `–†–µ–∑—É–ª—å—Ç–∞—Ç –∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–æ–π ‚Äî ${correctCount}/${questions.length} (${percent}%)`;
    let html = `<!doctype html><html><head><meta charset="utf-8"><title>${title}</title>
      <style>body{font-family:Arial,Helvetica,sans-serif;padding:20px;color:#071029} h1{font-size:18px} .q{margin-bottom:12px;padding:8px;border-bottom:1px solid #eee}</style></head><body>`;
    html += `<h1>${title}</h1><p>–í—Ä–µ–º—è: ${timerEl.textContent}</p>`;
    details.forEach((d, idx)=>{
      html += `<div class="q"><div><strong>–í–æ–ø—Ä–æ—Å ${idx+1} ‚Äî ${d.topic}</strong></div><div>${d.prompt}</div><div>–í–∞—à –æ—Ç–≤–µ—Ç: ${d.user === null || (String(d.user)==='NaN') ? '–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞' : d.user}</div><div>–ü—Ä–∞–≤–∏–ª—å–Ω—ã–π: ${d.correct}</div><div>–ü–æ—è—Å–Ω–µ–Ω–∏–µ: ${d.explanation}</div></div>`;
    });
    html += `<p>–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º —Ç—Ä–µ–Ω–∞–∂—ë—Ä–æ–≤. </p>`;
    html += `</body></html>`;
    const blob = new Blob([html], {type: 'text/html'});
    const url = URL.createObjectURL(blob);
    printOnlyLink.href = url;
    printOnlyLink.target = '_blank';
    // open print window when pressing printBtn
    printBtn.onclick = ()=> {
      const w = window.open(url, '_blank');
      if(!w) { alert('–ë–ª–æ–∫–∏—Ä–æ–≤—â–∏–∫ –≤—Å–ø–ª—ã–≤–∞—é—â–∏—Ö –æ–∫–æ–Ω –º–æ–∂–µ—Ç –ø–æ–º–µ—à–∞—Ç—å –æ—Ç–∫—Ä—ã—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É. –û—Ç–∫—Ä–æ–π—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Ä—É—á–Ω—É—é.'); return; }
      // try to invoke print after load
      w.addEventListener('load', ()=>{ try{ w.print(); } catch(e){} });
    };
  }

  // ======= Reset / create test =======
  function createTest(){
    finished = false;
    testArea.style.display = '';
    afterDiv.style.display = 'none';
    qIdCounter = 1;
    questions = generateQuestions(parseInt(numQuestionsEl.value,10));
    answers = {};
    currentIndex = 0;
    renderQuestion(currentIndex);
    updateProgressDisplay();
    startTimer();
  }

  // ======= Events =======
  prevBtn.addEventListener('click', ()=>{ goPrev(); });
  nextBtn.addEventListener('click', ()=>{ goNext(); });
  finishBtn.addEventListener('click', ()=>{ if(confirm('–í—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ —Ö–æ—Ç–∏—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å —Ç–µ—Å—Ç –∏ —É–≤–∏–¥–µ—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã? –ü–æ–¥—Å–∫–∞–∑–∫–∏ –æ—Ç–∫–ª—é—á–µ–Ω—ã.')) finishTest(); });
  resetBtn.addEventListener('click', ()=>{ if(confirm('–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Ç–µ—Å—Ç? –¢–µ–∫—É—â–∏–µ –æ—Ç–≤–µ—Ç—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.')) createTest(); });
  // allow Ctrl+Enter to finish
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Enter' && (e.ctrlKey || e.metaKey)){ finishTest(); } });

  // init
  createTest();

})();
</script>
</body>
</html>
